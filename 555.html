// load-manager.js - åŠ è½½ç®¡ç†å™¨
(function() {
    const scriptsToLoad = [
        { src: 'data.js', priority: 1 },
        { src: 'css.js', priority: 2 },
        { src: 'query.js', priority: 3 }
    ];
    
    let loadedCount = 0;
    let totalScripts = scriptsToLoad.length;
    
    function loadScript(scriptInfo, callback) {
        const script = document.createElement('script');
        script.src = scriptInfo.src;
        script.charset = 'UTF-8';
        
        script.onload = function() {
            console.log(`âœ… ${scriptInfo.src} åŠ è½½æˆåŠŸ`);
            loadedCount++;
            if (callback) callback();
        };
        
        script.onerror = function() {
            console.error(`âŒ ${scriptInfo.src} åŠ è½½å¤±è´¥`);
            loadedCount++;
            if (callback) callback();
        };
        
        document.head.appendChild(script);
    }
    
    function loadAllScripts() {
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        scriptsToLoad.sort((a, b) => a.priority - b.priority);
        
        // åˆ›å»ºåŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨
        createLoadingIndicator();
        
        // é¡ºåºåŠ è½½è„šæœ¬
        function loadNext(index) {
            if (index >= scriptsToLoad.length) {
                console.log('ğŸ‰ æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ');
                removeLoadingIndicator();
                return;
            }
            
            loadScript(scriptsToLoad[index], function() {
                // å»¶è¿Ÿ 100ms åŠ è½½ä¸‹ä¸€ä¸ªè„šæœ¬ï¼Œç¡®ä¿æ‰§è¡Œé¡ºåº
                setTimeout(() => {
                    loadNext(index + 1);
                }, 100);
            });
        }
        
        // å¼€å§‹åŠ è½½
        setTimeout(() => {
            loadNext(0);
        }, 300); // åˆå§‹å»¶è¿Ÿ
    }
    
    function createLoadingIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'loading-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f0f0f0;
            z-index: 9999;
        `;
        
        const progressBar = document.createElement('div');
        progressBar.id = 'loading-progress';
        progressBar.style.cssText = `
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #007AFF, #00C6FF);
            transition: width 0.3s ease;
        `;
        
        indicator.appendChild(progressBar);
        document.body.appendChild(indicator);
        
        // æ›´æ–°è¿›åº¦
        const progressInterval = setInterval(() => {
            const progress = (loadedCount / totalScripts) * 100;
            progressBar.style.width = progress + '%';
            
            if (progress >= 100) {
                clearInterval(progressInterval);
            }
        }, 100);
    }
    
    function removeLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            // æ·¡å‡ºåŠ¨ç”»
            indicator.style.opacity = '0';
            indicator.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 500);
        }
    }
    
    // é¡µé¢åŠ è½½åå¼€å§‹åŠ è½½è„šæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAllScripts);
    } else {
        loadAllScripts();
    }
})();